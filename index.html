<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat Privé Sécurisé</title>
    <style>
        /* Styles pour une interface propre */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        #chat-box { width: 400px; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #messages { height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; flex-direction: column; }
        #typing { font-size: 0.8em; color: #888; padding: 5px 20px; height: 20px; }
        #input-area { display: flex; padding: 15px; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button { background: #0084ff; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        
        /* Bulles de messages */
        .msg { margin-bottom: 12px; padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 0.95em; line-height: 1.4; }
        .sent { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body>

<div id="chat-box">
    <div style="padding:15px; background:#0084ff; color:white; text-align:center; font-weight:bold;">Discussion Privée</div>
    <div id="messages"></div>
    <div id="typing"></div>
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="Votre message...">
        <button id="send-btn">Envoyer</button>
    </div>
</div>

<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    // 1. Connexion au serveur
    const socket = io("http://localhost:3000");

    // 2. Récupération du salon dans l'URL (ex: index.html?room=L3)
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room') || 'salon_general';
    const CLE_SECRET = "MA_CLE_L3_2026"; // Clé de chiffrement identique pour tous

    // On rejoint le salon
    socket.emit('join-room', room);

    const input = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const msgDiv = document.getElementById('messages');
    const typingStatus = document.getElementById('typing');

    // Fonction pour afficher un message à l'écran
    function afficher(sender, texte, estMoi) {
        const div = document.createElement('div');
        div.className = estMoi ? 'msg sent' : 'msg';
        div.innerHTML = `<strong>${sender}:</strong> <br> ${texte}`;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight; // Scroll vers le bas
    }

    // --- ENVOI DE MESSAGE ---
    sendBtn.onclick = () => {
        if(input.value) {
            // Chiffrement AES du message avant l'envoi
            const encrypted = CryptoJS.AES.encrypt(input.value, CLE_SECRET).toString();
            
            // Envoi au serveur
            socket.emit('chat-message', { room: room, msg: encrypted, sender: "Moi" });
            
            afficher("Moi", input.value, true);
            input.value = "";
        }
    };

    // --- RÉCEPTION DE MESSAGE ---
    socket.on('receive-message', (data) => {
        // Déchiffrement du message reçu
        const bytes = CryptoJS.AES.decrypt(data.msg, CLE_SECRET);
        const texteClair = bytes.toString(CryptoJS.enc.Utf8);
        afficher(data.sender, texteClair, false);
    });

    // --- CHARGEMENT HISTORIQUE ---
    socket.on('load-history', (history) => {
        history.forEach(d => {
            const bytes = CryptoJS.AES.decrypt(d.contenu_chiffre, CLE_SECRET);
            const texteClair = bytes.toString(CryptoJS.enc.Utf8);
            afficher(d.expediteur, texteClair, d.expediteur === "Moi");
        });
    });

    // --- INDICATEUR DE FRAPPE ---
    input.oninput = () => socket.emit('typing', { room: room, sender: "L'autre" });
    socket.on('is-typing', (data) => {
        typingStatus.innerText = data.sender + " est en train d'écrire...";
        setTimeout(() => { typingStatus.innerText = ""; }, 2000);
    });
</script>
</body>
</html>